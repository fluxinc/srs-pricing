<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile SRS Bridge - Fleet Discount Program</title>
  <script src="config.js"></script>
  <script src="pricing.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #222222;
      color: #f5f5f7;
      line-height: 1.5;
      padding: 1rem;
    }

    .container { max-width: 900px; margin: 0 auto; }

    .header { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.5rem; }
    .logo {
      height: 32px;
      width: auto;
      order: 2;
    }
    h1 { font-size: 1.5rem; font-weight: 600; order: 1; }

    .subtitle { color: #86868b; margin-bottom: 1.5rem; font-size: 0.9rem; }
    .tagline { color: #e84200; font-weight: 500; }

    .controls {
      background: #1c1c1e;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #2c2c2e;
    }

    .control-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 1.25rem;
    }

    @media (max-width: 900px) {
      .control-row { grid-template-columns: 1fr; gap: 1rem; }
    }

    label { display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .commitment-value { color: #e84200; font-weight: 600; }

    .slider-container { display: flex; align-items: center; gap: 0.75rem; }

    input[type="range"] {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: #3a3a3c;
      border-radius: 4px;
      outline: none;
      min-width: 0;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #e84200;
      border-radius: 50%;
      cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #e84200;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .slider-value { font-size: 1.1rem; font-weight: 600; min-width: 70px; text-align: right; white-space: nowrap; }

    .contract-buttons { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 0.4rem; margin-top: 0.5rem; }
    .contract-btn {
      background: #2c2c2e;
      border: 1px solid #3a3a3c;
      color: #f5f5f7;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
      text-align: center;
    }
    .contract-btn:hover { background: #3a3a3c; }
    .contract-btn.active {
      background: #e84200;
      border-color: #e84200;
      font-weight: 600;
    }

    @media (max-width: 640px) {
      .contract-buttons { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 400px) {
      .contract-btn { padding: 0.4rem 0.5rem; font-size: 0.75rem; }
    }

    .commitment-bar {
      position: sticky;
      top: 0.5rem;
      z-index: 20;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.75rem;
      background: #1c1c1e;
      border: 1px solid #2c2c2e;
      border-radius: 10px;
      font-size: 0.9rem;
    }
    .commitment-bar .commitment-label { color: #86868b; }

    .discount-highlight {
      background: linear-gradient(135deg, #1a3a1a 0%, #1c1c1e 100%);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #2d5a2d;
      text-align: center;
    }

    .discount-title {
      font-size: 0.8rem;
      color: #86868b;
      margin-bottom: 0.5rem;
    }

    .discount-amount {
      font-size: 2rem;
      font-weight: 700;
      color: #4ade80;
    }

    .discount-subtitle {
      font-size: 0.8rem;
      color: #86868b;
      margin-top: 0.5rem;
    }

    .discount-breakdown {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .discount-item {
      text-align: center;
      min-width: 80px;
    }

    .discount-label {
      font-size: 0.7rem;
      color: #86868b;
    }

    .discount-value {
      font-size: 1rem;
      font-weight: 600;
    }

    .discount-value.active { color: #4ade80; }

    @media (max-width: 640px) {
      .discount-amount { font-size: 1.75rem; }
      .discount-title { font-size: 0.75rem; }
      .discount-subtitle { font-size: 0.75rem; }
      .discount-breakdown { gap: 1rem; }
    }

    @media (min-width: 641px) {
      body { padding: 2rem; }
      .controls { padding: 1.5rem; }
      .discount-highlight { padding: 1.5rem; margin-bottom: 1.5rem; }
      h1 { font-size: 2rem; }
      .logo { height: 40px; }
      .subtitle { margin-bottom: 2rem; font-size: 1rem; }
      .controls { margin-bottom: 1.5rem; }
    }

    .table-container {
      background: #1c1c1e;
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid #2c2c2e;
      overflow-x: auto;
      margin-bottom: 1rem;
      -webkit-overflow-scrolling: touch;
    }

    .table-title { font-weight: 600; margin-bottom: 0.75rem; font-size: 0.95rem; }

    table { width: 100%; border-collapse: collapse; min-width: 500px; }
    th, td { padding: 0.6rem 0.5rem; text-align: right; border-bottom: 1px solid #2c2c2e; }
    th { font-weight: 600; color: #86868b; font-size: 0.75rem; white-space: nowrap; }
    th:first-child, td:first-child { text-align: left; }
    tr:last-child td { border-bottom: none; }

    .part-number { font-family: monospace; color: #e84200; font-size: 0.9rem; font-weight: 600; white-space: nowrap; }
    .price-main { font-size: 1.1rem; font-weight: 600; }
    .price-sub { font-size: 0.75rem; color: #86868b; }
    .discount-badge {
      display: inline-block;
      background: #e84200;
      color: #222222;
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .fleet-tiers-table {
      background: #1c1c1e;
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid #2c2c2e;
      margin-bottom: 1rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .fleet-tiers-table table {
      width: 100%;
      min-width: 450px;
    }

    .fleet-tiers-table th {
      text-align: left;
      padding: 0.5rem 0.4rem;
    }

    .fleet-tiers-table td {
      padding: 0.5rem 0.4rem;
    }

    .fleet-tiers-table tr.current-tier {
      background: rgba(74, 222, 128, 0.1);
    }

    .fleet-tiers-table .tier-marker {
      color: #4ade80;
      font-weight: 600;
    }

    @media (min-width: 641px) {
      .table-container { padding: 1.5rem; margin-bottom: 1.5rem; }
      .fleet-tiers-table { padding: 1.5rem; margin-bottom: 1.5rem; }
      .table-title { margin-bottom: 1rem; font-size: 1rem; }
      th, td { padding: 0.75rem 1rem; }
      th { font-size: 0.875rem; }
      .part-number { font-size: 1rem; }
      .price-main { font-size: 1.25rem; }
      .price-sub { font-size: 0.875rem; }
    }

    .chart-container {
      background: #1c1c1e;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .chart-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }
    .chart-wrapper {
      position: relative;
      height: 240px;
    }

    .footer { margin-top: 1.5rem; text-align: center; color: #86868b; font-size: 0.75rem; line-height: 1.4; }

    .pitch-section {
      background: #1c1c1e;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #2c2c2e;
    }

    .pitch-section h2 {
      font-size: 1.1rem;
      margin-bottom: 0.75rem;
      color: #e84200;
    }

    .pitch-section p {
      color: #a1a1a6;
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
    }

    .pitch-section ul {
      list-style: none;
      padding-left: 0;
    }

    .pitch-section li {
      padding: 0.25rem 0;
      color: #a1a1a6;
      font-size: 0.9rem;
    }

    .pitch-section li::before {
      content: "-> ";
      color: #e84200;
    }

    .pitch-section p.closing { margin-top: 1rem; }

    @media (min-width: 641px) {
      .chart-container { padding: 1.5rem; margin-bottom: 1.5rem; }
      .chart-title { margin-bottom: 1rem; font-size: 1rem; }
      .chart-wrapper { height: 280px; }
      .footer { margin-top: 2rem; font-size: 0.875rem; }
      .pitch-section { padding: 1.5rem; margin-bottom: 1.5rem; }
      .pitch-section h2 { font-size: 1.25rem; margin-bottom: 1rem; }
      .pitch-section p, .pitch-section li { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="logo.png" alt="Flux" class="logo">
      <h1>Mobile SRS Bridge</h1>
    </div>
    <p class="subtitle">
      <span class="tagline">Installed-Base + Commitment Pricing: "Commit More, Save More"</span>
    </p>

    <div class="commitment-bar">
      <span class="commitment-label">Total Commitment</span>
      <span id="totalCommitment" class="commitment-value">360 units</span>
    </div>

    <div class="controls">
      <div class="control-row">
        <div>
          <label>Monthly Order Rate (units/mo)</label>
          <div class="slider-container">
            <input type="range" id="rateSlider" min="10" max="25" step="1" value="10" aria-label="Monthly order rate">
            <span class="slider-value"><span id="rateValue">10</span>/mo</span>
          </div>
        </div>
        <div>
          <label>Commitment Duration (years)</label>
          <div class="slider-container">
            <input type="range" id="durationSlider" min="1" max="5" step="1" value="3" aria-label="Commitment duration">
            <span class="slider-value"><span id="durationValue">3</span> yr</span>
          </div>
        </div>
        <div>
          <label>Contract Length (per unit)</label>
          <div class="contract-buttons" id="contractButtons"></div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-title">Per-Unit Pricing by Part Number</div>
      <table id="pricingTable">
        <thead>
          <tr>
            <th>Part Number</th>
            <th>Year 1</th>
            <th>Year 2+ (per yr)</th>
            <th>Total Price</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="discount-highlight">
      <div class="discount-title">Your Total Year 2+ Discount</div>
      <div class="discount-amount" id="totalY2Discount">30%</div>
      <div class="discount-subtitle">
        Y2+ Price: <span id="y2PriceDisplay">$1,100</span>/unit/year (list: <span id="y2ListDisplay">$1,550</span>)
      </div>
      <div class="discount-breakdown" style="display: none;"></div>
    </div>

    <div class="fleet-tiers-table">
      <div class="table-title">Volume Discount Tiers (blended units)</div>
      <table id="volumeTiersTable">
        <thead>
          <tr>
            <th>Blended Units</th>
            <th>Volume Discount</th>
            <th>Y1 Discount</th>
            <th>Example Y2+ Price</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="chart-container">
      <div class="chart-title">Total Contract Price by Commitment Level</div>
      <div class="chart-wrapper">
        <canvas id="priceChart"></canvas>
      </div>
    </div>

    <div class="pitch-section">
      <h2>How Your Discounts Work</h2>
      <p>Your pricing is based on two simple factors:</p>
      <ul>
        <li><strong>Volume Commitment:</strong> Discount basis blends annual rate and duration (annual units + a duration-weighted add-on). Higher monthly rates unlock deeper discounts sooner.</li>
        <li><strong>Contract Length:</strong> Longer per-unit contracts (1/3/5/10 year) reduce pricing</li>
      </ul>
      <p class="closing"><strong>The more you commit upfront, the more you save across the entire deal.</strong></p>
    </div>

    <div class="footer" id="footer"></div>
  </div>

  <script>
    const CONTRACT_YEARS = Object.keys(CONFIG.contractDiscounts)
      .map(Number)
      .filter(Number.isFinite)
      .sort((a, b) => a - b);
    let selectedContract = Math.max(...CONTRACT_YEARS);
    let priceChart = null;
    const TAB_ID = Math.random().toString(36).slice(2);
    const stateChannel = ('BroadcastChannel' in window) ? new BroadcastChannel('srs-state') : null;

    function deepMerge(target, source) {
      if (!source || typeof source !== 'object') return target;
      Object.keys(source).forEach(key => {
        if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
          if (!target[key]) target[key] = {};
          deepMerge(target[key], source[key]);
        } else {
          target[key] = source[key];
        }
      });
      return target;
    }

    function getConfigOverrides() {
      return JSON.parse(JSON.stringify(CONFIG));
    }

    function getUiState() {
      return {
        rate: parseInt(document.getElementById('rateSlider').value),
        duration: parseInt(document.getElementById('durationSlider').value),
        selectedContract: selectedContract,
      };
    }

    function loadUiState() {
      try {
        const raw = localStorage.getItem('srs-ui-public');
        return raw ? JSON.parse(raw) : null;
      } catch (err) {
        return null;
      }
    }

    function saveUiState() {
      try {
        localStorage.setItem('srs-ui-public', JSON.stringify(getUiState()));
      } catch (err) {
        // ignore storage failures
      }
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/config', { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.json();
      } catch (err) {
        console.warn('Failed to load config', err);
        return null;
      }
    }

    let saveTimer = null;
    function scheduleSave() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveUiState, 200);
    }

    function broadcastConfigUpdate() {
      const message = { type: 'config-updated', source: TAB_ID, ts: Date.now() };
      if (stateChannel) {
        stateChannel.postMessage(message);
        return;
      }
      try {
        localStorage.setItem('srs-state-ping', JSON.stringify(message));
      } catch (err) {
        // ignore storage failures
      }
    }

    function setActiveContract(years) {
      selectedContract = years;
      document.querySelectorAll('.contract-btn').forEach(b => b.classList.remove('active'));
      const active = document.querySelector(`.contract-btn[data-years="${years}"]`);
      if (active) active.classList.add('active');
    }

    function setInputClamped(input, value) {
      if (!input || !Number.isFinite(value)) return;
      const min = parseFloat(input.min);
      const max = parseFloat(input.max);
      let next = value;
      if (Number.isFinite(min)) next = Math.max(min, next);
      if (Number.isFinite(max)) next = Math.min(max, next);
      input.value = next;
    }

    function applyState(state) {
      if (!state) return;
      if (state.config) {
        deepMerge(CONFIG, state.config);
      }
      if (state.ui) {
        setInputClamped(document.getElementById('rateSlider'), state.ui.rate);
        setInputClamped(document.getElementById('durationSlider'), state.ui.duration);
        if (Number.isFinite(state.ui.selectedContract)) selectedContract = state.ui.selectedContract;
      }
      if (!CONTRACT_YEARS.includes(selectedContract)) {
        selectedContract = Math.max(...CONTRACT_YEARS);
      }
      setActiveContract(selectedContract);
      update();
    }

    function buildTierRanges() {
      const mins = CONFIG.discounts.volumeTiers.map(t => t.minUnits).concat([0]);
      const uniq = Array.from(new Set(mins)).sort((a, b) => a - b);
      return uniq.map((min, idx) => {
        const next = uniq[idx + 1];
        const max = Number.isFinite(next) ? next - 1 : Infinity;
        const label = Number.isFinite(next) ? `${min}-${max} units` : `${min}+ units`;
        return { min, max, label };
      });
    }

    function renderContractButtons() {
      const container = document.getElementById('contractButtons');
      container.innerHTML = '';
      CONTRACT_YEARS.forEach((years) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'contract-btn';
        btn.dataset.years = years;
        btn.textContent = `${years}-Year`;
        container.appendChild(btn);
      });
    }

    function update() {
      const rate = parseInt(document.getElementById('rateSlider').value);
      const duration = parseInt(document.getElementById('durationSlider').value);
      const existingFleet = (CONFIG.fleet && Number.isFinite(CONFIG.fleet.existingUnits))
        ? CONFIG.fleet.existingUnits
        : 0;

      // Total commitment = rate × 12 × duration
      const totalUnits = PRICING.totalCommitment(rate, duration);
      const discountUnits = PRICING.discountBasisUnits(rate, duration);

      document.getElementById('rateValue').textContent = rate;
      document.getElementById('durationValue').textContent = duration;
      document.getElementById('totalCommitment').textContent = totalUnits + ' units';

      // Get discount breakdown
      const discounts = PRICING.getDiscountBreakdown(rate, duration, selectedContract, existingFleet);

      // Discount breakdown (hidden in public view)

      // Total Y2+ discount (effective vs max list)
      const y2Price = PRICING.year2Price(rate, duration, selectedContract, existingFleet);
      const y2ListDisplay = PRICING.displayListYear2(existingFleet);
      const totalY2Effective = y2ListDisplay > 0 ? Math.max(0, 1 - (y2Price / y2ListDisplay)) : 0;
      document.getElementById('totalY2Discount').textContent = PRICING.formatPercent(totalY2Effective);
      document.getElementById('y2PriceDisplay').textContent = PRICING.formatCurrency(y2Price);
      document.getElementById('y2ListDisplay').textContent = PRICING.formatCurrency(y2ListDisplay);

      // Volume tiers table
      const volumeTbody = document.querySelector('#volumeTiersTable tbody');
      volumeTbody.innerHTML = '';

      const tiers = buildTierRanges();
      const listY2Display = PRICING.displayListYear2(existingFleet);

      tiers.forEach(tier => {
        const volumeDisc = PRICING.volumeDiscount(tier.min);
        const y1VolumeDisc = volumeDisc * CONFIG.discounts.year1VolumeFactor;
        const contractDisc = PRICING.contractDiscount(selectedContract);
        const exampleY2Price = PRICING.roundUp10(listY2Display * (1 - volumeDisc - contractDisc));
        const isCurrent = discountUnits >= tier.min && discountUnits <= tier.max;

        const row = document.createElement('tr');
        if (isCurrent) row.classList.add('current-tier');

        row.innerHTML = `
          <td>${isCurrent ? '<span class="tier-marker">-></span> ' : ''}${tier.label}</td>
          <td>${Math.round(volumeDisc * 100)}%</td>
          <td>${Math.round(y1VolumeDisc * 100)}%</td>
          <td>${PRICING.formatCurrency(exampleY2Price)}/year</td>
        `;
        volumeTbody.appendChild(row);
      });

      // Pricing table
      const tbody = document.querySelector('#pricingTable tbody');
      tbody.innerHTML = '';

      CONTRACT_YEARS.forEach(contractYrs => {
        const y1 = PRICING.year1Price(rate, duration, contractYrs, existingFleet);
        const y2 = PRICING.year2Price(rate, duration, contractYrs, existingFleet);
        const totalContract = y1 + (y2 * Math.max(0, contractYrs - 1));
        const y1ListDisplay = PRICING.displayListYear1();
        const y1Disc = y1ListDisplay > 0 ? Math.max(0, 1 - (y1 / y1ListDisplay)) : 0;
        const y2ListDisplay = PRICING.displayListYear2(existingFleet);
        const y2Price = PRICING.year2Price(rate, duration, contractYrs, existingFleet);
        const y2Raw = PRICING.year2PriceRaw(rate, duration, contractYrs, existingFleet);
        const y2RawRounded = PRICING.roundUp10(y2Raw);
        const y2Clamp = Math.max(0, y2Price - y2RawRounded);
        const y2Disc = contractYrs > 1 && y2ListDisplay > 0 ? Math.max(0, 1 - (y2Price / y2ListDisplay)) : 0;

        const row = document.createElement('tr');
        const isSelected = contractYrs === selectedContract;
        if (isSelected) row.style.background = 'rgba(232, 66, 0, 0.1)';

        row.innerHTML = `
          <td>
            <span class="part-number">FX-SRS-${contractYrs}YR</span>
          </td>
          <td>
            <div class="price-main">${PRICING.formatCurrency(y1)}</div>
            <div class="price-sub">${y1Disc > 0 ? Math.round(y1Disc * 100) + '% off' : ''}</div>
          </td>
          <td>
            <div class="price-main">${contractYrs > 1 ? PRICING.formatCurrency(y2) : '-'}</div>
            <div class="price-sub">${contractYrs > 1 ? (y2Disc > 0 ? Math.round(y2Disc * 100) + '% off' : '') : ''}</div>
            ${contractYrs > 1 && y2Clamp > 0 ? `<div class="price-sub">min-gap +${PRICING.formatCurrency(y2Clamp)}</div>` : ''}
          </td>
          <td>
            <div class="price-main">${PRICING.formatCurrency(totalContract)}</div>
            <div class="price-sub">${contractYrs} year total</div>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Update chart
      updateChart(rate, duration, totalUnits, existingFleet);

      // Footer
      const nextTier = PRICING.getNextVolumeTier(discountUnits);
      let footerText = `${rate}/mo × ${duration} years = ${totalUnits} units committed. `;
      if (nextTier) {
        const unitsNeeded = nextTier.minUnits - discountUnits;
        footerText += `${Math.ceil(unitsNeeded)} more blended units reaches ${Math.round(nextTier.discount * 100)}% volume discount.`;
      } else {
        footerText += 'Maximum volume discount tier achieved!';
      }
      footerText += ' Committed rate sets the price ceiling, which then remains based on the size of the fleet currently under contract.';
      document.getElementById('footer').textContent = footerText;
    }

    // Contract button handlers
    function bindContractButtons() {
      document.querySelectorAll('.contract-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          setActiveContract(parseInt(btn.dataset.years));
          update();
          scheduleSave();
        });
      });
    }

    renderContractButtons();
    setActiveContract(selectedContract);
    bindContractButtons();

    document.getElementById('rateSlider').addEventListener('input', () => { update(); scheduleSave(); });
    document.getElementById('durationSlider').addEventListener('input', () => { update(); scheduleSave(); });

    // Initialize price chart - shows total contract price by commitment level
    const PILOT_CAPS = { 1: 7000, 3: 8500, 5: 9800, 10: 15000 };
    const chartCanvas = document.getElementById('priceChart');
    if (chartCanvas && window.Chart) {
      const ctx = chartCanvas.getContext('2d');
      priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['120', '240', '360', '480', '500', '600'],
          datasets: [
            {
              label: 'Total Contract Price',
              data: [],
              borderColor: '#e84200',
              backgroundColor: 'rgba(232, 66, 0, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 4,
              pointBackgroundColor: '#e84200',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#1c1c1e',
              titleColor: '#f5f5f7',
              bodyColor: '#f5f5f7',
              borderColor: '#3a3a3c',
              borderWidth: 1,
              callbacks: {
                label: ctx => 'Total: $' + ctx.raw.toLocaleString()
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Total Commitment (units)', color: '#86868b' },
              ticks: { color: '#86868b' },
              grid: { color: '#2c2c2e' }
            },
            y: {
              title: { display: true, text: 'Contract Price per Unit ($)', color: '#86868b' },
              ticks: { color: '#86868b', callback: v => '$' + v },
              grid: { color: '#2c2c2e' }
            }
          }
        }
      });
    } else {
      console.warn('Chart.js unavailable: skipping chart render.');
    }

    function updateChart(rate, duration, currentCommitment, existingFleet) {
      if (!priceChart) return;

      // Show contract prices at different commitment levels (hold duration constant)
      const minUnits = 120;
      const maxUnits = Math.max(600, Math.ceil(currentCommitment * 1.5 / 20) * 20);
      const step = Math.max(20, Math.round((maxUnits - minUnits) / 14 / 10) * 10);
      const commitmentLevels = [];
      for (let units = minUnits; units <= maxUnits; units += step) {
        commitmentLevels.push(units);
      }
      if (!commitmentLevels.includes(currentCommitment)) {
        commitmentLevels.push(currentCommitment);
      }
      commitmentLevels.sort((a, b) => a - b);

      const tempDuration = Math.max(1, duration);
      const prices = commitmentLevels.map(units => {
        const tempRate = units / (tempDuration * 12);
        return PRICING.contractPrice(tempRate, tempDuration, selectedContract, existingFleet);
      });

      const pilotCap = PILOT_CAPS[selectedContract] || Math.max(...Object.values(PILOT_CAPS));
      const cappedPrices = prices.map(price => Math.min(price, pilotCap));

      priceChart.data.labels = commitmentLevels.map(String);
      priceChart.data.datasets[0].data = cappedPrices;

      const minPrice = Math.min(...cappedPrices);
      const padding = Math.max(100, Math.ceil((pilotCap - minPrice) * 0.1));
      const yMin = Math.max(0, Math.floor((minPrice - padding) / 20) * 20);
      const yMax = Math.ceil(pilotCap / 20) * 20;
      priceChart.options.scales.y.min = yMin;
      priceChart.options.scales.y.max = yMax;

      // Highlight current commitment position
      const currentIdx = commitmentLevels.findIndex((c, i) => {
        const next = commitmentLevels[i + 1] || Infinity;
        return currentCommitment >= c && currentCommitment < next;
      });
      priceChart.data.datasets[0].pointRadius = commitmentLevels.map((c, i) => {
        if (i === currentIdx || (currentIdx === -1 && c >= currentCommitment)) return 8;
        return 4;
      });

      priceChart.update();
    }

    async function init() {
      const config = await loadConfig();
      if (config) {
        deepMerge(CONFIG, config);
      }
      const uiState = loadUiState();
      if (uiState || config) {
        applyState({ config, ui: uiState });
      } else {
        setActiveContract(selectedContract);
        update();
      }
    }

    // Initialize
    init();

    if (stateChannel) {
      stateChannel.onmessage = async (event) => {
        const msg = event.data || {};
        if (msg.type !== 'config-updated' || msg.source === TAB_ID) return;
        const config = await loadConfig();
        if (config) {
          applyState({ config });
        }
      };
    } else {
      window.addEventListener('storage', async (event) => {
        if (event.key !== 'srs-state-ping' || !event.newValue) return;
        try {
          const msg = JSON.parse(event.newValue);
          if (msg.source === TAB_ID) return;
          if (msg.type !== 'config-updated') return;
        } catch (err) {
          return;
        }
        const config = await loadConfig();
        if (config) {
          applyState({ config });
        }
      });
    }
  </script>
</body>
</html>
